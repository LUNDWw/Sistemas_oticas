<!doctype html>
<html lang="pt-BR">

<head>
  <meta charset="utf-8">
  <title>{{ action }} Pedido - Gestão Ótica</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="{{ url_for('static', filename='bootstrap.min.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='custom.css') }}">
  <link rel="icon" href="{{ url_for('static', filename='image/logo.ico') }}">
</head>

<body>
  {% include 'navbar.html' %}

  <main class="container my-4">
    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    <div class="toast-container">
      {% for category, msg in messages %}
      <div class="toast align-items-center text-white bg-{{ 'success' if category=='success' else 'danger' }} border-0"
        role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
          <div class="toast-body">
            {{ msg }}
          </div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"
            aria-label="Close"></button>
        </div>
      </div>
      {% endfor %}
    </div>
    {% endif %}
    {% endwith %}

    <div class="row justify-content-center">
      <div class="col-lg-10">
        <div class="card shadow-sm">
          <div class="card-header d-flex justify-content-between align-items-center">
            <h4 class="mb-0">{{ action }} Pedido</h4>
            <a href="{{ url_for('main.index') }}" class="btn btn-sm btn-outline-secondary">Voltar</a>
          </div>
          <div class="card-body">
            <form method="post" class="needs-validation" novalidate>
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

              <!-- Dados do Cliente -->
              <h5 class="mb-3 text-primary border-bottom pb-2">Dados do Cliente</h5>
              <div class="row g-3 mb-4">
                <div class="col-md-2">
                  <label for="os_number" class="form-label">Nº OS</label>
                  <input type="text" class="form-control" id="os_number" name="os_number"
                    value="{{ order.os_number if order else '' }}" required>
                </div>
                <div class="col-md-5">
                  <label for="client_name" class="form-label">Nome do Cliente</label>
                  <input type="text" class="form-control" id="client_name" name="client_name"
                    value="{{ order.client_name if order else '' }}" required>
                </div>
                <div class="col-md-3">
                  <label for="phone" class="form-label">Telefone</label>
                  <input type="text" class="form-control" id="phone" name="phone"
                    value="{{ order.phone if order else '' }}">
                </div>
                <div class="col-md-2">
                  <label for="cpf" class="form-label">CPF</label>
                  <input type="text" class="form-control" id="cpf" name="cpf" value="{{ order.cpf if order else '' }}">
                </div>
                <div class="col-md-12">
                  <label for="endereco" class="form-label">Endereço</label>
                  <input type="text" class="form-control" id="endereco" name="endereco"
                    value="{{ order.endereco if order else '' }}">
                </div>
              </div>

              <!-- Detalhes da Compra -->
              <h5 class="mb-3 text-primary border-bottom pb-2">Detalhes da Compra</h5>
              <div class="row g-3 mb-4">
                <div class="col-md-4">
                  <label for="purchase_type" class="form-label">Tipo de Compra</label>
                  <select class="form-select" id="purchase_type" name="purchase_type">
                    <option value="Óculos de Grau" {{ 'selected' if order and order.purchase_type=='Óculos de Grau'
                      else '' }}>Óculos de Grau</option>
                    <option value="Óculos de Sol" {{ 'selected' if order and order.purchase_type=='Óculos de Sol'
                      else '' }}>Óculos de Sol</option>
                    <option value="Lente de Contato" {{ 'selected' if order and order.purchase_type=='Lente de Contato'
                      else '' }}>Lente de Contato</option>
                    <option value="Conserto" {{ 'selected' if order and order.purchase_type=='Conserto' else '' }}>
                      Conserto</option>
                  </select>
                </div>
                <div class="col-md-4">
                  <label for="store" class="form-label">Loja</label>
                  <input type="text" class="form-control" id="store" name="store"
                    value="{{ order.store if order else '' }}">
                </div>
                <div class="col-md-4">
                  <label for="lab" class="form-label">Laboratório</label>
                  <input type="text" class="form-control" id="lab" name="lab" value="{{ order.lab if order else '' }}">
                </div>
                <div class="col-md-3">
                  <label for="exam_date" class="form-label">Data do Exame</label>
                  <input type="date" class="form-control" id="exam_date" name="exam_date"
                    value="{{ order.exam_date if order else '' }}" required>
                </div>
                <div class="col-md-3">
                  <label for="delivery_date" class="form-label">Previsão de Entrega</label>
                  <input type="date" class="form-control" id="delivery_date" name="delivery_date"
                    value="{{ order.delivery_date if order else '' }}" required>
                </div>
                <div class="col-md-3 d-flex align-items-end">
                  <div class="form-check mb-2">
                    <input class="form-check-input" type="checkbox" id="lab_paid" name="lab_paid" {{ 'checked' if order
                      and order.lab_paid else '' }}>
                    <label class="form-check-label" for="lab_paid">Laboratório Pago?</label>
                  </div>
                </div>
              </div>

              <!-- Receita -->
              <h5 class="mb-3 text-primary border-bottom pb-2">Receita</h5>
              <div class="row g-3 mb-4">
                <div class="col-md-12">
                  <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="receita_fora" name="receita_fora" {{ 'checked'
                      if order and order.receita_fora else '' }}>
                    <label class="form-check-label" for="receita_fora">Receita de Fora?</label>
                  </div>
                </div>
                <div class="col-md-6" id="div_doutor_fora" style="display: none;">
                  <label for="nome_doutor_fora" class="form-label">Nome do Doutor (Fora)</label>
                  <input type="text" class="form-control" id="nome_doutor_fora" name="nome_doutor_fora"
                    value="{{ order.nome_doutor_fora if order else '' }}">
                </div>
                <div class="col-md-6" id="div_doutor_otica">
                  <label for="nome_doutor_otica" class="form-label">Nome do Doutor (Ótica)</label>
                  <input type="text" class="form-control" id="nome_doutor_otica" name="nome_doutor_otica"
                    value="{{ order.nome_doutor_otica if order else '' }}">
                </div>
              </div>

              <!-- Pagamento -->
              <h5 class="mb-3 text-primary border-bottom pb-2">Pagamento</h5>
              <div class="row g-3 mb-4">
                <div class="col-md-3">
                  <label for="payment_status" class="form-label">Status</label>
                  <select class="form-select" id="payment_status" name="payment_status">
                    <option value="Pendente" {{ 'selected' if order and order.payment_status=='Pendente' else '' }}>
                      Pendente</option>
                    <option value="Pago" {{ 'selected' if order and order.payment_status=='Pago' else '' }}>Pago
                    </option>
                  </select>
                </div>
                <div class="col-md-3">
                  <label for="payment_method" class="form-label">Método</label>
                  <select class="form-select" id="payment_method" name="payment_method">
                    <option value="Dinheiro" {{ 'selected' if order and order.payment_method=='Dinheiro' else '' }}>
                      Dinheiro</option>
                    <option value="Cartão de Crédito" {{ 'selected' if order and
                      order.payment_method=='Cartão de Crédito' else '' }}>Cartão de Crédito</option>
                    <option value="Cartão de Débito" {{ 'selected' if order and order.payment_method=='Cartão de Débito'
                      else '' }}>Cartão de Débito</option>
                    <option value="Pix" {{ 'selected' if order and order.payment_method=='Pix' else '' }}>Pix</option>
                  </select>
                </div>
                <div class="col-md-2">
                  <label for="installments" class="form-label">Parcelas</label>
                  <input type="number" class="form-control" id="installments" name="installments"
                    value="{{ order.installments if order else 1 }}" min="1">
                </div>
                <div class="col-md-4">
                  <label for="valor_pago" class="form-label">Valor Total</label>
                  <div class="input-group">
                    <span class="input-group-text">R$</span>
                    <input type="number" step="0.01" min="0" class="form-control" id="valor_pago" name="valor_pago"
                      value="{{ order.valor_pago if order else '' }}" required>
                  </div>
                </div>
                <div class="col-md-4">
                  <label for="entrada" class="form-label">Entrada</label>
                  <div class="input-group">
                    <span class="input-group-text">R$</span>
                    <input type="number" step="0.01" min="0" class="form-control" id="entrada" name="entrada"
                      value="{{ order.entrada if order else '' }}">
                  </div>
                </div>
                <div class="col-md-12">
                  <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="pagamento_retirada" name="pagamento_retirada"
                      {{ 'checked' if order and order.valor_retirada> 0 else '' }}>
                    <label class="form-check-label" for="pagamento_retirada">Pagamento na Retirada?</label>
                  </div>
                </div>
                <div class="col-md-4" id="div_valor_retirada" style="display: none;">
                  <label for="valor_retirada" class="form-label">Valor na Retirada</label>
                  <div class="input-group">
                    <span class="input-group-text">R$</span>
                    <input type="number" step="0.01" class="form-control" id="valor_retirada" name="valor_retirada"
                      value="{{ order.valor_retirada if order else '' }}">
                  </div>
                </div>
              </div>

              <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                <button type="submit" class="btn btn-primary btn-lg px-5" id="submitBtn" data-loading-text="Salvando...">Salvar Pedido</button>
              </div>
            </form>
          </div>
        </div>

        <script>
          // Enhanced loading state
          document.querySelector('form').addEventListener('submit', function(e) {
              if (this.checkValidity() === false) {
                  e.preventDefault();
                  e.stopPropagation();
              } else {
                  const btn = document.getElementById('submitBtn');
                  btn.disabled = true;
                  btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>' + btn.dataset.loadingText;
              }
          });
        </script>

        <!-- Seção de Graus (Apenas Edição) -->
        {% if action == 'Editar' %}
        <div class="card shadow-sm mt-4">
          <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Graus / Lentes</h5>
            <button type="button" class="btn btn-sm btn-outline-primary" data-bs-toggle="modal"
              data-bs-target="#modalNewGrau">
              Adicionar Grau
            </button>
          </div>
          <div class="card-body">
            {% if graus %}
            <div class="table-responsive">
              <table class="table table-hover">
                <thead>
                  <tr>
                    <th>Para</th>
                    <th>Olho</th>
                    <th>Esf</th>
                    <th>Cil</th>
                    <th>Eixo</th>
                    <th>DNP</th>
                    <th>Tipo</th>
                    <th>Ações</th>
                  </tr>
                </thead>
                <tbody>
                  {% for grau in graus %}
                  <tr>
                    <td>{{ grau.lens_for }}</td>
                    <td>{{ grau.eye }}</td>
                    <td>{{ grau.esf }}</td>
                    <td>{{ grau.cil }}</td>
                    <td>{{ grau.eixo }}</td>
                    <td>{{ grau.dnp }}</td>
                    <td>{{ grau.lens_type }}</td>
                    <td>
                      <button type="button" class="btn btn-sm btn-outline-primary me-1" data-bs-toggle="modal"
                        data-bs-target="#modalEditGrau" data-id="{{ grau.id }}" data-lens-for="{{ grau.lens_for }}"
                        data-eye="{{ grau.eye }}" data-esf="{{ grau.esf }}" data-cil="{{ grau.cil }}"
                        data-eixo="{{ grau.eixo }}" data-dnp="{{ grau.dnp }}" data-indice="{{ grau.indice }}"
                        data-lens-type="{{ grau.lens_type }}" data-adicao="{{ grau.adicao }}">
                        Editar
                      </button>
                      <form action="{{ url_for('order.delete_grau', order_id=order.id, grau_id=grau.id) }}"
                        method="post" class="d-inline" onsubmit="return confirm('Tem certeza?');" no-loading>
                        <button type="submit" class="btn btn-sm btn-outline-danger">Excluir</button>
                      </form>
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
            {% else %}
            <p class="text-muted text-center py-3">Nenhum grau cadastrado.</p>
            {% endif %}
          </div>
        </div>
        {% endif %}
      </div>
    </div>
  </main>

  <!-- Modal Novo Grau -->
  {% if action == 'Editar' %}
  <div class="modal fade" id="modalNewGrau" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Adicionar Grau</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form action="{{ url_for('order.new_grau', order_id=order.id) }}" method="post">
            <div class="row g-3">
              <div class="col-6">
                <label class="form-label">Para</label>
                <select name="lens_for" class="form-select">
                  <option value="Perto">Perto</option>
                  <option value="Longe">Longe</option>
                  <option value="Multifocal">Multifocal</option>
                </select>
              </div>
              <div class="col-6">
                <label class="form-label">Olho</label>
                <select name="eye" class="form-select">
                  <option value="OD">Direito (OD)</option>
                  <option value="OE">Esquerdo (OE)</option>
                </select>
              </div>
              <div class="col-4"><label class="form-label">Esférico</label><input type="text" name="esf"
                  class="form-control"></div>
              <div class="col-4"><label class="form-label">Cilíndrico</label><input type="text" name="cil"
                  class="form-control"></div>
              <div class="col-4"><label class="form-label">Eixo</label><input type="text" name="eixo"
                  class="form-control"></div>
              <div class="col-6"><label class="form-label">DNP</label><input type="text" name="dnp"
                  class="form-control"></div>
              <div class="col-6"><label class="form-label">Adição</label><input type="text" name="adicao"
                  class="form-control"></div>
              <div class="col-12"><label class="form-label">Tipo de Lente</label><input type="text" name="lens_type"
                  class="form-control"></div>
              <div class="col-12"><label class="form-label">Índice</label><input type="text" name="indice"
                  class="form-control"></div>
            </div>
            <div class="mt-4 text-end">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
              <button type="submit" class="btn btn-primary">Salvar</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
  {% endif %}

  <!-- Modal Editar Grau -->
  {% if action == 'Editar' %}
  <div class="modal fade" id="modalEditGrau" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Editar Grau</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="formEditGrau" method="post">
            <div class="row g-3">
              <div class="col-6">
                <label class="form-label">Para</label>
                <select name="lens_for" id="edit_lens_for" class="form-select">
                  <option value="Perto">Perto</option>
                  <option value="Longe">Longe</option>
                  <option value="Multifocal">Multifocal</option>
                </select>
              </div>
              <div class="col-6">
                <label class="form-label">Olho</label>
                <select name="eye" id="edit_eye" class="form-select">
                  <option value="OD">Direito (OD)</option>
                  <option value="OE">Esquerdo (OE)</option>
                </select>
              </div>
              <div class="col-4"><label class="form-label">Esférico</label><input type="text" name="esf" id="edit_esf"
                  class="form-control"></div>
              <div class="col-4"><label class="form-label">Cilíndrico</label><input type="text" name="cil" id="edit_cil"
                  class="form-control"></div>
              <div class="col-4"><label class="form-label">Eixo</label><input type="text" name="eixo" id="edit_eixo"
                  class="form-control"></div>
              <div class="col-6"><label class="form-label">DNP</label><input type="text" name="dnp" id="edit_dnp"
                  class="form-control"></div>
              <div class="col-6"><label class="form-label">Adição</label><input type="text" name="adicao"
                  id="edit_adicao" class="form-control"></div>
              <div class="col-12"><label class="form-label">Tipo de Lente</label><input type="text" name="lens_type"
                  id="edit_lens_type" class="form-control"></div>
              <div class="col-12"><label class="form-label">Índice</label><input type="text" name="indice"
                  id="edit_indice" class="form-control"></div>
            </div>
            <div class="mt-4 text-end">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
              <button type="submit" class="btn btn-primary">Salvar Alterações</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
  {% endif %}

  <script src="{{ url_for('static', filename='bootstrap.bundle.min.js') }}"></script>
  <script src="{{ url_for('static', filename='app.js') }}"></script>
  <script src="{{ url_for('static', filename='validation.js') }}"></script>
  <script>
    // Lógica de exibição condicional
    document.addEventListener('DOMContentLoaded', function () {
      // Receita de Fora
      const checkReceita = document.getElementById('receita_fora');
      const divDoutorFora = document.getElementById('div_doutor_fora');
      const divDoutorOtica = document.getElementById('div_doutor_otica');

      function toggleReceita() {
        if (checkReceita.checked) {
          divDoutorFora.style.display = 'block';
          divDoutorOtica.style.display = 'none';
        } else {
          divDoutorFora.style.display = 'none';
          divDoutorOtica.style.display = 'block';
        }
      }
      if (checkReceita) {
        checkReceita.addEventListener('change', toggleReceita);
        toggleReceita();
      }

      // Pagamento Retirada
      const checkRetirada = document.getElementById('pagamento_retirada');
      const divValorRetirada = document.getElementById('div_valor_retirada');

      function toggleRetirada() {
        if (checkRetirada.checked) {
          divValorRetirada.style.display = 'block';
        } else {
          divValorRetirada.style.display = 'none';
        }
      }
      if (checkRetirada) {
        checkRetirada.addEventListener('change', toggleRetirada);
        toggleRetirada();
      }

      // Máscaras (reaplicando aqui para garantir, embora validation.js possa ter)
      var phoneInput = document.getElementById('phone');
      if (phoneInput) {
        phoneInput.addEventListener('input', function (e) {
          var x = e.target.value.replace(/\D/g, '').match(/(\d{0,2})(\d{0,5})(\d{0,4})/);
          e.target.value = !x[2] ? x[1] : '(' + x[1] + ') ' + x[2] + (x[3] ? '-' + x[3] : '');
        });
      }

      var cpfInput = document.getElementById('cpf');
      if (cpfInput) {
        cpfInput.addEventListener('input', function (e) {
          var x = e.target.value.replace(/\D/g, '').match(/(\d{0,3})(\d{0,3})(\d{0,3})(\d{0,2})/);
          e.target.value = !x[2] ? x[1] : x[1] + '.' + x[2] + (x[3] ? '.' + x[3] : '') + (x[4] ? '-' + x[4] : '');
        });
      }
    });

    // Script para Modal de Edição de Grau
    const modalEditGrau = document.getElementById('modalEditGrau');
    if (modalEditGrau) {
      modalEditGrau.addEventListener('show.bs.modal', event => {
        const button = event.relatedTarget;

        // Extrair dados dos atributos data-*
        const id = button.getAttribute('data-id');
        const lensFor = button.getAttribute('data-lens-for');
        const eye = button.getAttribute('data-eye');
        const esf = button.getAttribute('data-esf');
        const cil = button.getAttribute('data-cil');
        const eixo = button.getAttribute('data-eixo');
        const dnp = button.getAttribute('data-dnp');
        const indice = button.getAttribute('data-indice');
        const lensType = button.getAttribute('data-lens-type');
        const adicao = button.getAttribute('data-adicao');

        // Atualizar action do form
        // A rota é /order/<order_id>/grau/edit/<grau_id>
        // Podemos pegar o order_id da URL atual ou injetar via template, mas a URL base já ajuda.
        // Melhor usar a estrutura que já temos. O form action precisa ser montado dinamicamente.
        // Vamos usar um placeholder no action ou construir a string.
        // Como estamos no template Jinja, podemos usar {{ order.id }} se disponível.
        const form = document.getElementById('formEditGrau');
        form.action = `/order/{{ order.id if order else 0 }}/grau/edit/${id}`;

        // Preencher campos
        document.getElementById('edit_lens_for').value = lensFor;
        document.getElementById('edit_eye').value = eye;
        document.getElementById('edit_esf').value = esf;
        document.getElementById('edit_cil').value = cil;
        document.getElementById('edit_eixo').value = eixo;
        document.getElementById('edit_dnp').value = dnp;
        document.getElementById('edit_indice').value = indice;
        document.getElementById('edit_lens_type').value = lensType;
        document.getElementById('edit_adicao').value = adicao;
      });
    }
  </script>
</body>

</html>